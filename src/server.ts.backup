#!/usr/bin/env node

/**
 * Benchmark å¯è§†åŒ–æœåŠ¡å™¨
 * 
 * æä¾› Web ç•Œé¢æ¥æŸ¥çœ‹å’Œæ“ä½œåŸºå‡†æµ‹è¯•ç»“æœ
 */

import { createServer } from 'node:http'
import { readFileSync, existsSync, readdirSync } from 'node:fs'
import { join } from 'node:path'
import path from 'node:path'
import { WebSocketServer, WebSocket } from 'ws'
import type { BenchmarkResult, ProgressInfo } from './types.js'
// import { fileURLToPath } from 'node:url'

// const __dirname = fileURLToPath(new URL('.', import.meta.url))

interface ServerOptions {
  port: number
  host: string
  historyDir: string
  enableWebSocket?: boolean
}

/**
 * WebSocket æ¶ˆæ¯ç±»å‹
 */
export interface WSMessage {
  type: 'progress' | 'result' | 'error' | 'status' | 'complete'
  payload: unknown
}

export interface ProgressMessage extends WSMessage {
  type: 'progress'
  payload: ProgressInfo
}

export interface ResultMessage extends WSMessage {
  type: 'result'
  payload: {
    suite: string
    result: BenchmarkResult
  }
}

export interface CompleteMessage extends WSMessage {
  type: 'complete'
  payload: {
    suite: string
    results: BenchmarkResult[]
  }
}

export class BenchmarkServer {
  private server: any
  private wss: WebSocketServer | null = null
  private wsClients: Set<WebSocket> = new Set()
  private options: ServerOptions

  constructor(options: Partial<ServerOptions> = {}) {
    this.options = {
      port: options.port || 3000,
      host: options.host || 'localhost',
      historyDir: options.historyDir || join(process.cwd(), '.benchmark-history'),
      enableWebSocket: options.enableWebSocket !== false
    }
  }

  /**
   * å¯åŠ¨æœåŠ¡å™¨
   */
  async start(): Promise<void> {
    this.server = createServer(this.handleRequest.bind(this))

    // åˆå§‹åŒ– WebSocket æœåŠ¡å™¨
    if (this.options.enableWebSocket) {
      this.wss = new WebSocketServer({ server: this.server })
      this.setupWebSocket()
    }

    return new Promise((resolve, reject) => {
      this.server.listen(this.options.port, this.options.host, (err?: Error) => {
        if (err) {
          reject(err)
        } else {
          console.log(`ğŸš€ Benchmark æœåŠ¡å™¨å·²å¯åŠ¨`)
          console.log(`ğŸ“Š è®¿é—®åœ°å€: http://${this.options.host}:${this.options.port}`)
          console.log(`ğŸ“š å†å²è®°å½•ç›®å½•: ${this.options.historyDir}`)
          if (this.options.enableWebSocket) {
            console.log(`ğŸ”Œ WebSocket å·²å¯ç”¨ (å®æ—¶æ¨é€)`)
          }
          resolve()
        }
      })
    })
  }

  /**
   * è®¾ç½® WebSocket æœåŠ¡å™¨
   */
  private setupWebSocket(): void {
    if (!this.wss) return

    this.wss.on('connection', (ws: WebSocket) => {
      console.log('ğŸ“¡ æ–°çš„ WebSocket è¿æ¥')
      this.wsClients.add(ws)

      // å‘é€æ¬¢è¿æ¶ˆæ¯
      this.sendToClient(ws, {
        type: 'status',
        payload: {
          message: 'Connected to Benchmark Server',
          timestamp: new Date().toISOString(),
          clientCount: this.wsClients.size
        }
      })

      ws.on('close', () => {
        console.log('ğŸ“¡ WebSocket è¿æ¥å…³é—­')
        this.wsClients.delete(ws)
      })

      ws.on('error', (error) => {
        console.error('WebSocket é”™è¯¯:', error)
        this.wsClients.delete(ws)
      })
    })
  }

  /**
   * å‘é€æ¶ˆæ¯ç»™å•ä¸ªå®¢æˆ·ç«¯
   */
  private sendToClient(ws: WebSocket, message: WSMessage): void {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(message))
    }
  }

  /**
   * å¹¿æ’­è¿›åº¦æ›´æ–°
   */
  broadcastProgress(progress: ProgressInfo): void {
    const message: ProgressMessage = {
      type: 'progress',
      payload: progress
    }
    this.broadcast(message)
  }

  /**
   * å¹¿æ’­ç»“æœ
   */
  broadcastResult(suite: string, result: BenchmarkResult): void {
    const message: ResultMessage = {
      type: 'result',
      payload: { suite, result }
    }
    this.broadcast(message)
  }

  /**
   * å¹¿æ’­å¥—ä»¶å®Œæˆ
   */
  broadcastComplete(suite: string, results: BenchmarkResult[]): void {
    const message: CompleteMessage = {
      type: 'complete',
      payload: { suite, results }
    }
    this.broadcast(message)
  }

  /**
   * å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
   */
  private broadcast(message: WSMessage): void {
    const data = JSON.stringify(message)
    this.wsClients.forEach(ws => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(data)
      }
    })
  }

  /**
   * åœæ­¢æœåŠ¡å™¨
   */
  async stop(): Promise<void> {
    // å…³é—­æ‰€æœ‰ WebSocket è¿æ¥
    if (this.wss) {
      this.wsClients.forEach(ws => {
        ws.close()
      })
      this.wss.close()
    }

    return new Promise((resolve) => {
      if (this.server) {
        this.server.close(() => {
          console.log('ğŸ‘‹ Benchmark æœåŠ¡å™¨å·²åœæ­¢')
          resolve()
        })
      } else {
        resolve()
      }
    })
  }

  /**
   * å¤„ç† HTTP è¯·æ±‚
   */
  private async handleRequest(req: any, res: any): Promise<void> {
    const url = new URL(req.url || '/', `http://${req.headers.host}`)
    const pathname = url.pathname

    // è®¾ç½® CORS å¤´
    res.setHeader('Access-Control-Allow-Origin', '*')
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type')

    if (req.method === 'OPTIONS') {
      res.writeHead(200)
      res.end()
      return
    }

    try {
      if (pathname === '/' || pathname === '/index.html') {
        await this.serveDashboard(req, res)
      } else if (pathname === '/api/history') {
        await this.serveHistoryList(req, res)
      } else if (pathname.startsWith('/api/report/')) {
        await this.serveReport(req, res, pathname)
      } else if (pathname === '/api/compare') {
        await this.serveComparison(req, res)
      } else if (pathname === '/api/status') {
        await this.serveStatus(req, res)
      } else if (pathname.startsWith('/api/trend/')) {
        await this.serveTrendData(req, res, pathname)
      } else {
        res.writeHead(404, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({ error: 'Not Found' }))
      }
    } catch (error) {
      console.error('æœåŠ¡å™¨é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({ error: 'Internal Server Error' }))
    }
  }

  /**
   * æä¾›ä»ªè¡¨æ¿é¡µé¢
   */
  private async serveDashboard(_req: any, res: any): Promise<void> {
    const dashboardHTML = this.getDashboardHTML()
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' })
    res.end(dashboardHTML)
  }

  /**
   * è·å–ä»ªè¡¨æ¿ HTML
   */
  private getDashboardHTML(): string {
    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Benchmark Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .status-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .status-indicator.connected { background: #4caf50; animation: pulse 2s infinite; }
    .status-indicator.disconnected { background: #f44336; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .dashboard { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    .sidebar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-height: 600px; overflow-y: auto; }
    .main-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; padding: 40px; color: #666; }
    .live-indicator { background: #ff5722; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .history-item { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; transition: background 0.2s; }
    .history-item:hover { background: #f5f5f5; }
    .history-item.active { background: #e3f2fd; border-left: 3px solid #2196f3; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š LDesign Benchmark Dashboard</h1>
      <p>å®æ—¶æ€§èƒ½ç›‘æ§å’Œå¯è§†åŒ–åˆ†æ (Enhanced with WebSocket)</p>
    </div>
    
    <div class="status-bar">
      <div>
        <span class="status-indicator disconnected" id="wsStatus"></span>
        <span id="wsStatusText">è¿æ¥ä¸­...</span>
      </div>
      <div id="liveProgress" style="display: none;">
        <span class="live-indicator">ğŸ”´ LIVE</span>
        <span id="progressText" style="margin-left: 10px;"></span>
      </div>
    </div>
    
    <div class="dashboard">
      <div class="sidebar">
        <h3>ğŸ“š å†å²è®°å½•</h3>
        <div id="historyList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div class="main-content">
        <div id="reportView">
          <div class="loading">
            <h3>é€‰æ‹©å·¦ä¾§çš„å†å²è®°å½•æŸ¥çœ‹è¯¦æƒ…</h3>
            <p>æˆ–è€…è¿è¡Œ <code>ldbench run --history</code> ç”Ÿæˆæ–°çš„åŸºå‡†æµ‹è¯•æŠ¥å‘Š</p>
            <p style="margin-top: 20px; color: #666;">
              <strong>æ–°åŠŸèƒ½:</strong><br>
              â€¢ WebSocket å®æ—¶æ¨é€<br>
              â€¢ è¶‹åŠ¿æ•°æ® API: /api/trend/{suite}/{task}<br>
              â€¢ å¤šæŠ¥å‘Šå¯¹æ¯” API: /api/compare?reports=id1,id2,id3
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class BenchmarkDashboard {
      constructor() {
        this.currentReport = null
        this.ws = null
        this.connectWebSocket()
        this.loadHistory()
      }

      connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
        const wsUrl = protocol + '//' + window.location.host
        
        try {
          this.ws = new WebSocket(wsUrl)
          
          this.ws.onopen = () => {
            console.log('WebSocket connected')
            document.getElementById('wsStatus').className = 'status-indicator connected'
            document.getElementById('wsStatusText').textContent = 'WebSocket å·²è¿æ¥'
          }
          
          this.ws.onmessage = (event) => {
            const message = JSON.parse(event.data)
            this.handleWebSocketMessage(message)
          }
          
          this.ws.onclose = () => {
            document.getElementById('wsStatus').className = 'status-indicator disconnected'
            document.getElementById('wsStatusText').textContent = 'WebSocket å·²æ–­å¼€'
          }
        } catch (error) {
          console.error('WebSocket connection failed:', error)
        }
      }

      handleWebSocketMessage(message) {
        if (message.type === 'progress') {
          const p = message.payload
          document.getElementById('liveProgress').style.display = 'block'
          document.getElementById('progressText').textContent = 
            p.suite + ' - ' + p.task + ' (' + p.current + '/' + p.total + ') ' + p.percentage.toFixed(1) + '%'
        } else if (message.type === 'complete') {
          document.getElementById('liveProgress').style.display = 'none'
          this.loadHistory()
        }
      }

      async loadHistory() {
        const response = await fetch('/api/history')
        const history = await response.json()
        this.renderHistory(history)
      }

      renderHistory(history) {
        const html = history.length === 0 ? '<div class="loading">æš‚æ— å†å²è®°å½•</div>' :
          history.map(item => {
            return '<div class="history-item" onclick="dashboard.selectReport(\\'' + item.id + '\\')">' +
              '<div style="font-weight: bold;">' + new Date(item.timestamp).toLocaleString('zh-CN') + '</div>' +
              '<div style="color: #666; font-size: 0.9em;">' + item.suites + ' ä¸ªå¥—ä»¶ â€¢ ' + item.totalTasks + ' ä¸ªä»»åŠ¡</div>' +
            '</div>'
          }).join('')
        document.getElementById('historyList').innerHTML = html
      }

      async selectReport(reportId) {
        document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'))
        event.target.closest('.history-item').classList.add('active')
        
        const response = await fetch('/api/report/' + reportId)
        this.currentReport = await response.json()
        this.renderReport(this.currentReport)
      }

      renderReport(report) {
        const stats = {
          totalSuites: report.suites.length,
          totalTasks: report.suites.reduce((sum, suite) => sum + suite.results.length, 0)
        }
        let html = '<h2>' + report.name + '</h2>' +
          '<p style="color: #666;">ç”Ÿæˆæ—¶é—´: ' + new Date(report.generatedAt).toLocaleString('zh-CN') + '</p>' +
          '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">' +
            '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center;">' +
              '<div style="font-size: 24px; font-weight: bold;">' + stats.totalSuites + '</div>' +
              '<div style="color: #666;">æµ‹è¯•å¥—ä»¶</div>' +
            '</div>' +
            '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center;">' +
              '<div style="font-size: 24px; font-weight: bold;">' + stats.totalTasks + '</div>' +
              '<div style="color: #666;">æµ‹è¯•ä»»åŠ¡</div>' +
            '</div>' +
          '</div>'
        
        report.suites.forEach(suite => {
          html += '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
            '<h3>' + suite.name + '</h3>' +
            '<div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">' +
              '<div style="font-weight: bold;">ä»»åŠ¡åç§°</div>' +
              '<div style="font-weight: bold;">æ“ä½œ/ç§’</div>' +
              '<div style="font-weight: bold;">å¹³å‡æ—¶é—´</div>' +
              '<div style="font-weight: bold;">è¯¯å·®</div>'
          
          suite.results.forEach(r => {
            html += '<div>' + r.name + '</div>' +
              '<div>' + this.formatOps(r.opsPerSecond) + '</div>' +
              '<div>' + r.avgTime.toFixed(4) + 'ms</div>' +
              '<div>Â±' + r.rme.toFixed(2) + '%</div>'
          })
          
          html += '</div></div>'
        })
        
        document.getElementById('reportView').innerHTML = html
      }

      formatOps(ops) {
        if (ops >= 1000000) return (ops / 1000000).toFixed(1) + 'M'
        if (ops >= 1000) return (ops / 1000).toFixed(1) + 'K'
        return ops.toFixed(0)
      }
    }

    const dashboard = new BenchmarkDashboard()
    window.dashboard = dashboard
  </script>
</body>
</html>`
  }
<html lang="zh-CN" >
  <head>
  <meta charset="UTF-8" >
    <meta name="viewport" content = "width=device-width, initial-scale=1.0" >
      <title>LDesign Benchmark Dashboard </title>
        < script src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" > </script>
          <style>
    :root {
  --bg - primary: #ffffff;
  --bg - secondary: #f5f5f5;
  --text - primary: #333333;
  --text - secondary: #666666;
  --border - color: #dddddd;
  --accent - color: #2196f3;
  --success - color: #4caf50;
  --warning - color: #ff9800;
  --error - color: #f44336;
  --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

[data - theme="dark"] {
  --bg - primary: #1e1e1e;
  --bg - secondary: #2d2d2d;
  --text - primary: #e0e0e0;
  --text - secondary: #b0b0b0;
  --border - color: #404040;
  --accent - color: #64b5f6;
  --success - color: #81c784;
  --warning - color: #ffb74d;
  --error - color: #e57373;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
    
    * { box- sizing: border - box; margin: 0; padding: 0; }
    body {
  font - family: -apple - system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans - serif;
  background: var(--bg - secondary);
  color: var(--text - primary);
  transition: background 0.3s, color 0.3s;
}
    .container { max - width: 1400px; margin: 0 auto; padding: 20px; }
    .header {
  background: var(--bg - primary);
  padding: 20px;
  border - radius: 8px;
  box - shadow: var(--shadow);
  margin - bottom: 20px;
  display: flex;
  justify - content: space - between;
  align - items: center;
}
    .header h1 { font - size: 24px; }
    .theme - toggle {
  background: var(--accent - color);
  color: white;
  border: none;
  padding: 8px 16px;
  border - radius: 4px;
  cursor: pointer;
  font - size: 14px;
}
    .theme - toggle:hover { opacity: 0.9; }
    .status - bar {
  background: var(--bg - primary);
  padding: 15px;
  border - radius: 8px;
  margin - bottom: 20px;
  box - shadow: var(--shadow);
  display: flex;
  justify - content: space - between;
  align - items: center;
}
    .status - indicator {
  display: inline - block;
  width: 10px;
  height: 10px;
  border - radius: 50 %;
  margin - right: 8px;
}
    .status - indicator.connected { background: var(--success - color); animation: pulse 2s infinite; }
    .status - indicator.disconnected { background: var(--error - color); }
@keyframes pulse { 0 %, 100 % { opacity: 1; } 50 % { opacity: 0.5; } }
    .tabs {
  display: flex;
  gap: 10px;
  margin - bottom: 20px;
}
    .tab {
  background: var(--bg - primary);
  border: none;
  padding: 12px 24px;
  border - radius: 8px 8px 0 0;
  cursor: pointer;
  font - size: 14px;
  color: var(--text - primary);
  transition: all 0.2s;
}
    .tab:hover { background: var(--accent - color); color: white; }
    .tab.active { background: var(--accent - color); color: white; }
    .tab - content { display: none; }
    .tab - content.active { display: block; }
    .dashboard { display: grid; grid - template - columns: 1fr 2fr; gap: 20px; }
    .sidebar {
  background: var(--bg - primary);
  padding: 20px;
  border - radius: 8px;
  box - shadow: var(--shadow);
  max - height: 600px;
  overflow - y: auto;
}
    .main - content {
  background: var(--bg - primary);
  padding: 20px;
  border - radius: 8px;
  box - shadow: var(--shadow);
}
    .history - item {
  padding: 12px;
  border - bottom: 1px solid var(--border - color);
  cursor: pointer;
  transition: background 0.2s;
  border - radius: 4px;
  margin - bottom: 4px;
}
    .history - item:hover { background: var(--bg - secondary); }
    .history - item.active { background: var(--accent - color); color: white; }
    .chart - container { position: relative; height: 300px; margin: 20px 0; }
    .comparison - grid {
  display: grid;
  grid - template - columns: repeat(auto - fit, minmax(300px, 1fr));
  gap: 15px;
  margin - top: 20px;
}
    .comparison - card {
  background: var(--bg - secondary);
  padding: 15px;
  border - radius: 8px;
  border - left: 4px solid var(--accent - color);
}
    .comparison - card.improving { border - left - color: var(--success - color); }
    .comparison - card.degrading { border - left - color: var(--error - color); }
    .loading { text - align: center; padding: 40px; color: var(--text - secondary); }
    .live - indicator {
  background: var(--error - color);
  color: white;
  padding: 4px 12px;
  border - radius: 12px;
  font - size: 12px;
  font - weight: bold;
  animation: blink 1.5s infinite;
}
@keyframes blink { 0 %, 100 % { opacity: 1; } 50 % { opacity: 0.6; } }
    .btn {
  background: var(--accent - color);
  color: white;
  border: none;
  padding: 8px 16px;
  border - radius: 4px;
  cursor: pointer;
  font - size: 14px;
  margin: 5px;
}
    .btn:hover { opacity: 0.9; }
    .btn - secondary { background: var(--text - secondary); }
    select {
  background: var(--bg - primary);
  color: var(--text - primary);
  border: 1px solid var(--border - color);
  padding: 8px;
  border - radius: 4px;
  font - size: 14px;
}
</style>
  </head>
  < body >
  <div class="container" >
    <div class="header" >
      <div>
      <h1>ğŸ“Š LDesign Benchmark Dashboard </h1>
        < p style = "color: var(--text-secondary); margin-top: 5px;" > å®æ—¶æ€§èƒ½ç›‘æ§å’Œå¯è§†åŒ–åˆ†æ </p>
          </div>
          < button class="theme-toggle" onclick = "dashboard.toggleTheme()" >ğŸŒ“ åˆ‡æ¢ä¸»é¢˜ </button>
            </div>

            < div class="status-bar" >
              <div>
              <span class="status-indicator disconnected" id = "wsStatus" > </span>
                < span id = "wsStatusText" > è¿æ¥ä¸­...</span>
                  </div>
                  < div id = "liveProgress" style = "display: none;" >
                    <span class="live-indicator" >ğŸ”´ LIVE </span>
                      < span id = "progressText" style = "margin-left: 10px;" > </span>
                        </div>
                        </div>

                        < div class="tabs" >
                          <button class="tab active" onclick = "dashboard.switchTab('reports')" >ğŸ“š æŠ¥å‘Šåˆ—è¡¨ </button>
                            < button class="tab" onclick = "dashboard.switchTab('trends')" >ğŸ“ˆ è¶‹åŠ¿åˆ†æ </button>
                              < button class="tab" onclick = "dashboard.switchTab('compare')" >âš–ï¸ å¯¹æ¯”åˆ†æ </button>
                                </div>

                                < div id = "reports-tab" class="tab-content active" >
                                  <div class="dashboard" >
                                    <div class="sidebar" >
                                      <h3>å†å²è®°å½• </h3>
                                      < div id = "historyList" > <div class="loading" > åŠ è½½ä¸­...</div></div >
                                        </div>
                                        < div class="main-content" >
                                          <div id="reportView" > <div class="loading" > é€‰æ‹©å·¦ä¾§çš„å†å²è®°å½•æŸ¥çœ‹è¯¦æƒ… < /div></div >
                                            </div>
                                            </div>
                                            </div>

                                            < div id = "trends-tab" class="tab-content" >
                                              <div class="main-content" >
                                                <h2>è¶‹åŠ¿åˆ†æ </h2>
                                                < div style = "margin: 20px 0;" >
                                                  <label>é€‰æ‹©å¥—ä»¶: <select id="trendSuite" onchange = "dashboard.loadTrendTasks()" > </select></label >
                                                    <label style="margin-left: 20px;" > é€‰æ‹©ä»»åŠ¡: <select id="trendTask" > </select></label >
                                                      <label style="margin-left: 20px;" > æ—¶é—´èŒƒå›´:
<select id="trendRange" >
  <option value="week" > æœ€è¿‘ä¸€å‘¨ </option>
    < option value = "month" selected > æœ€è¿‘ä¸€æœˆ </option>
      < option value = "quarter" > æœ€è¿‘ä¸‰æœˆ </option>
        < option value = "year" > æœ€è¿‘ä¸€å¹´ </option>
          </select>
          </label>
          < button class="btn" onclick = "dashboard.loadTrendChart()" > åŠ è½½è¶‹åŠ¿ </button>
            </div>
            < div class="chart-container" >
              <canvas id="trendChart" > </canvas>
                </div>
                < div id = "trendSummary" > </div>
                  </div>
                  </div>

                  < div id = "compare-tab" class="tab-content" >
                    <div class="main-content" >
                      <h2>å¯¹æ¯”åˆ†æ </h2>
                      < div style = "margin: 20px 0;" >
                        <p>é€‰æ‹©è¦å¯¹æ¯”çš„æŠ¥å‘Šï¼ˆè‡³å°‘2ä¸ªï¼‰ï¼š</p>
                          < div id = "compareSelection" > </div>
                            < button class="btn" onclick = "dashboard.loadComparison()" > å¼€å§‹å¯¹æ¯” </button>
                              </div>
                              < div id = "compareResults" > </div>
                                </div>
                                </div>
                                </div>

                                <script>
class BenchmarkDashboard {
  constructor() {
    this.currentReport = null
    this.ws = null
    this.theme = localStorage.getItem('theme') || 'light'
    this.trendChart = null
    this.allReports = []
    this.applyTheme()
    this.connectWebSocket()
    this.loadHistory()
  }

  toggleTheme() {
    this.theme = this.theme === 'light' ? 'dark' : 'light'
    localStorage.setItem('theme', this.theme)
    this.applyTheme()
  }

  applyTheme() {
    document.documentElement.setAttribute('data-theme', this.theme)
  }

  switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
    event.target.classList.add('active')
    document.getElementById(tabName + '-tab').classList.add('active')

    if (tabName === 'trends') this.initTrendTab()
    if (tabName === 'compare') this.initCompareTab()
  }

  connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
    const wsUrl = protocol + '//' + window.location.host

    try {
      this.ws = new WebSocket(wsUrl)
      this.ws.onopen = () => {
        console.log('WebSocket å·²è¿æ¥')
        document.getElementById('wsStatus').className = 'status-indicator connected'
        document.getElementById('wsStatusText').textContent = 'WebSocket å·²è¿æ¥'
      }
      this.ws.onmessage = (event) => {
        const message = JSON.parse(event.data)
        this.handleWebSocketMessage(message)
      }
      this.ws.onclose = () => {
        document.getElementById('wsStatus').className = 'status-indicator disconnected'
        document.getElementById('wsStatusText').textContent = 'WebSocket å·²æ–­å¼€'
      }
    } catch (error) {
      console.error('WebSocket è¿æ¥å¤±è´¥:', error)
    }
  }

  handleWebSocketMessage(message) {
    if (message.type === 'progress') {
      const p = message.payload
      document.getElementById('liveProgress').style.display = 'block'
      document.getElementById('progressText').textContent =
        p.suite + ' - ' + p.task + ' (' + p.current + '/' + p.total + ') ' + p.percentage.toFixed(1) + '%'
    } else if (message.type === 'complete') {
      document.getElementById('liveProgress').style.display = 'none'
      this.loadHistory()
    }
  }

  async loadHistory() {
    const response = await fetch('/api/history')
    this.allReports = await response.json()
    this.renderHistory(this.allReports)
  }

  renderHistory(history) {
    const html = history.length === 0 ? '<div class="loading">æš‚æ— å†å²è®°å½•</div>' :
      history.map(item =>
        '<div class="history-item" onclick="dashboard.selectReport(\\'' + item.id + '\\')">' +
        '<div style="font-weight: bold;">' + new Date(item.timestamp).toLocaleString('zh-CN') + '</div>' +
        '<div style="color: var(--text-secondary); font-size: 0.9em;">' +
        item.suites + ' ä¸ªå¥—ä»¶ â€¢ ' + item.totalTasks + ' ä¸ªä»»åŠ¡</div>' +
      '</div>'
      ).join('')
    document.getElementById('historyList').innerHTML = html
  }

  async selectReport(reportId) {
    document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'))
    event.target.closest('.history-item').classList.add('active')

    const response = await fetch('/api/report/' + reportId)
    this.currentReport = await response.json()
    this.renderReport(this.currentReport)
  }

  renderReport(report) {
    const stats = {
      totalSuites: report.suites.length,
      totalTasks: report.suites.reduce((sum, suite) => sum + suite.results.length, 0)
    }
    const html = '<h2>' + report.name + '</h2>' +
      '<p style="color: var(--text-secondary);">ç”Ÿæˆæ—¶é—´: ' + new Date(report.generatedAt).toLocaleString('zh-CN') + '</p>' +
      '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">' +
      '<div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + stats.totalSuites + '</div>' +
      '<div style="color: var(--text-secondary);">æµ‹è¯•å¥—ä»¶</div></div>' +
      '<div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + stats.totalTasks + '</div>' +
      '<div style="color: var(--text-secondary);">æµ‹è¯•ä»»åŠ¡</div></div>' +
      '</div>' +
      report.suites.map(suite =>
        '<div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
        '<h3>' + suite.name + '</h3>' +
        '<div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">' +
        '<div style="font-weight: bold;">ä»»åŠ¡åç§°</div>' +
        '<div style="font-weight: bold;">æ“ä½œ/ç§’</div>' +
        '<div style="font-weight: bold;">å¹³å‡æ—¶é—´</div>' +
        '<div style="font-weight: bold;">è¯¯å·®</div>' +
        suite.results.map(r =>
          '<div>' + r.name + '</div>' +
          '<div>' + this.formatOps(r.opsPerSecond) + '</div>' +
          '<div>' + r.avgTime.toFixed(4) + 'ms</div>' +
          '<div>Â±' + r.rme.toFixed(2) + '%</div>'
        ).join('') +
        '</div></div>'
      ).join('')
    document.getElementById('reportView').innerHTML = html
  }

  initTrendTab() {
    if (this.allReports.length === 0) return
    const suites = new Set()
    this.allReports.forEach(r => {
      fetch('/api/report/' + r.id).then(res => res.json()).then(report => {
        report.suites.forEach(s => suites.add(s.name))
      })
    })
    setTimeout(() => {
      const select = document.getElementById('trendSuite')
      select.innerHTML = Array.from(suites).map(s => '<option value="' + s + '">' + s + '</option>').join('')
      this.loadTrendTasks()
    }, 500)
  }

  async loadTrendTasks() {
    const suite = document.getElementById('trendSuite').value
    if (!suite || this.allReports.length === 0) return

    const tasks = new Set()
    for (const r of this.allReports.slice(0, 5)) {
      const response = await fetch('/api/report/' + r.id)
      const report = await response.json()
      const s = report.suites.find(s => s.name === suite)
      if (s) s.results.forEach(r => tasks.add(r.name))
    }

    document.getElementById('trendTask').innerHTML =
      Array.from(tasks).map(t => '<option value="' + t + '">' + t + '</option>').join('')
  }

  async loadTrendChart() {
    const suite = document.getElementById('trendSuite').value
    const task = document.getElementById('trendTask').value
    const range = document.getElementById('trendRange').value

    if (!suite || !task) return

    const response = await fetch('/api/trend/' + encodeURIComponent(suite) + '/' + encodeURIComponent(task) + '?range=' + range)
    const data = await response.json()

    if (this.trendChart) this.trendChart.destroy()

    const ctx = document.getElementById('trendChart').getContext('2d')
    this.trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.dataPoints.map(p => new Date(p.date).toLocaleDateString('zh-CN')),
        datasets: [{
          label: 'Ops/ç§’',
          data: data.dataPoints.map(p => p.opsPerSecond),
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } }
      }
    })

    document.getElementById('trendSummary').innerHTML =
      '<div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">' +
      '<h3>è¶‹åŠ¿æ‘˜è¦</h3>' +
      '<p>è¶‹åŠ¿: <strong>' + (data.trend === 'improving' ? 'ğŸ“ˆ æ”¹å–„' : data.trend === 'degrading' ? 'ğŸ“‰ ä¸‹é™' : 'â¡ï¸ ç¨³å®š') + '</strong></p>' +
      '<p>å˜åŒ–ç‡: <strong>' + data.changeRate.toFixed(2) + '%/å‘¨</strong></p>' +
      '<p>å¹³å‡ Ops/ç§’: <strong>' + data.summary.avgOpsPerSecond.toFixed(0) + '</strong></p>' +
      '<p>æ•°æ®ç‚¹æ•°: <strong>' + data.summary.totalPoints + '</strong></p>' +
      '</div>'
  }

  initCompareTab() {
    const html = this.allReports.map(r =>
      '<label style="display: block; margin: 10px 0;">' +
      '<input type="checkbox" value="' + r.id + '" class="compare-checkbox"> ' +
      new Date(r.timestamp).toLocaleString('zh-CN') + ' - ' + r.suites + ' ä¸ªå¥—ä»¶' +
      '</label>'
    ).join('')
    document.getElementById('compareSelection').innerHTML = html
  }

  async loadComparison() {
    const selected = Array.from(document.querySelectorAll('.compare-checkbox:checked')).map(c => c.value)
    if (selected.length < 2) {
      alert('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæŠ¥å‘Šè¿›è¡Œå¯¹æ¯”')
      return
    }

    const response = await fetch('/api/compare?reports=' + selected.join(','))
    const data = await response.json()

    const html = '<div style="margin-top: 20px;">' +
      '<h3>å¯¹æ¯”æ‘˜è¦</h3>' +
      '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">' +
      '<div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + data.summary.totalComparisons + '</div>' +
      '<div style="color: var(--text-secondary);">æ€»å¯¹æ¯”æ•°</div></div>' +
      '<div style="background: var(--success-color); color: white; padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + data.summary.improvements + '</div>' +
      '<div>æ”¹å–„</div></div>' +
      '<div style="background: var(--error-color); color: white; padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + data.summary.regressions + '</div>' +
      '<div>ä¸‹é™</div></div>' +
      '<div style="background: var(--text-secondary); color: white; padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + data.summary.stable + '</div>' +
      '<div>ç¨³å®š</div></div>' +
      '</div>' +
      '<div class="comparison-grid">' +
      data.comparisons.map(c =>
        '<div class="comparison-card ' + c.trend + '">' +
        '<h4>' + c.suite + ' - ' + c.task + '</h4>' +
        '<p>è¶‹åŠ¿: <strong>' + (c.trend === 'improving' ? 'ğŸ“ˆ æ”¹å–„' : c.trend === 'degrading' ? 'ğŸ“‰ ä¸‹é™' : 'â¡ï¸ ç¨³å®š') + '</strong></p>' +
        '<p>å˜åŒ–: <strong>' + c.improvement.toFixed(2) + '%</strong></p>' +
        '<p>å¹³å‡ Ops/ç§’: <strong>' + c.avgOpsPerSecond.toFixed(0) + '</strong></p>' +
        '</div>'
      ).join('') +
      '</div>' +
      '</div>'

    document.getElementById('compareResults').innerHTML = html
  }

  formatOps(ops) {
    if (ops >= 1000000) return (ops / 1000000).toFixed(1) + 'M'
    if (ops >= 1000) return (ops / 1000).toFixed(1) + 'K'
    return ops.toFixed(0)
  }
}

const dashboard = new BenchmarkDashboard()
window.dashboard = dashboard
  </script>
  </body>
  </html>`
  }
}
<html lang="zh-CN" >
  <head>
  <meta charset="UTF-8" >
    <meta name="viewport" content = "width=device-width, initial-scale=1.0" >
      <title>LDesign Benchmark Dashboard </title>
        <style>
    body { font - family: Arial, sans - serif; margin: 20px; background: #f5f5f5; }
    .container { max - width: 1200px; margin: 0 auto; }
    .header { text - align: center; margin - bottom: 30px; background: white; padding: 20px; border - radius: 8px; box - shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .status - bar { background: white; padding: 15px; border - radius: 8px; margin - bottom: 20px; box - shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: flex; justify - content: space - between; align - items: center; }
    .status - indicator { display: inline - block; width: 10px; height: 10px; border - radius: 50 %; margin - right: 8px; }
    .status - indicator.connected { background: #4caf50; animation: pulse 2s infinite; }
    .status - indicator.disconnected { background: #f44336; }
@keyframes pulse { 0 %, 100 % { opacity: 1; } 50 % { opacity: 0.5; } }
    .dashboard { display: grid; grid - template - columns: 1fr 2fr; gap: 20px; }
    .sidebar { background: white; padding: 20px; border - radius: 8px; box - shadow: 0 2px 4px rgba(0, 0, 0, 0.1); max - height: 600px; overflow - y: auto; }
    .main - content { background: white; padding: 20px; border - radius: 8px; box - shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .loading { text - align: center; padding: 40px; color: #666; }
    .progress - bar { width: 100 %; height: 4px; background: #e0e0e0; border - radius: 2px; overflow: hidden; margin - top: 10px; }
    .progress - fill { height: 100 %; background: linear - gradient(90deg, #4caf50, #8bc34a); transition: width 0.3s ease; }
    .live - indicator { background: #ff5722; color: white; padding: 4px 12px; border - radius: 12px; font - size: 12px; font - weight: bold; animation: blink 1.5s infinite; }
@keyframes blink { 0 %, 100 % { opacity: 1; } 50 % { opacity: 0.6; } }
    .history - item { padding: 10px; border - bottom: 1px solid #ddd; cursor: pointer; transition: background 0.2s; }
    .history - item:hover { background: #f5f5f5; }
    .history - item.active { background: #e3f2fd; border - left: 3px solid #2196f3; }
</style>
  </head>
  < body >
  <div class="container" >
    <div class="header" >
      <h1>ğŸ“Š LDesign Benchmark Dashboard </h1>
        < p > å®æ—¶æ€§èƒ½ç›‘æ§å’Œå¯è§†åŒ–åˆ†æ </p>
        </div>

        < div class="status-bar" >
          <div>
          <span class="status-indicator disconnected" id = "wsStatus" > </span>
            < span id = "wsStatusText" > è¿æ¥ä¸­...</span>
              </div>
              < div id = "liveProgress" style = "display: none;" >
                <span class="live-indicator" >ğŸ”´ LIVE </span>
                  < span id = "progressText" style = "margin-left: 10px;" > </span>
                    </div>
                    </div>

                    < div class="dashboard" >
                      <div class="sidebar" >
                        <h3>ğŸ“š å†å²è®°å½• </h3>
                          < div id = "historyList" >
                            <div class="loading" > åŠ è½½ä¸­...</div>
                              </div>
                              </div>

                              < div class="main-content" >
                                <div id="reportView" >
                                  <div class="loading" >
                                    <h3>é€‰æ‹©å·¦ä¾§çš„å†å²è®°å½•æŸ¥çœ‹è¯¦æƒ… </h3>
                                    < p > æˆ–è€…è¿è¡Œ < code > ldbench run--history < /code> ç”Ÿæˆæ–°çš„åŸºå‡†æµ‹è¯•æŠ¥å‘Š</p >
                                      </div>
                                      </div>
                                      </div>
                                      </div>
                                      </div>

                                      <script>
class BenchmarkDashboard {
  constructor() {
    this.currentReport = null
    this.ws = null
    this.reconnectAttempts = 0
    this.maxReconnectAttempts = 5
    this.connectWebSocket()
    this.loadHistory()
  }

  connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
    const wsUrl = protocol + '//' + window.location.host

    try {
      this.ws = new WebSocket(wsUrl)

      this.ws.onopen = () => {
        console.log('WebSocket å·²è¿æ¥')
        this.reconnectAttempts = 0
        this.updateConnectionStatus(true)
      }

      this.ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data)
          this.handleWebSocketMessage(message)
        } catch (error) {
          console.error('è§£æ WebSocket æ¶ˆæ¯å¤±è´¥:', error)
        }
      }

      this.ws.onclose = () => {
        console.log('WebSocket å·²æ–­å¼€')
        this.updateConnectionStatus(false)
        this.attemptReconnect()
      }

      this.ws.onerror = (error) => {
        console.error('WebSocket é”™è¯¯:', error)
      }
    } catch (error) {
      console.error('WebSocket è¿æ¥å¤±è´¥:', error)
      this.updateConnectionStatus(false)
    }
  }

  attemptReconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectAttempts++
      console.log('å°è¯•é‡æ–°è¿æ¥ WebSocket (' + this.reconnectAttempts + '/' + this.maxReconnectAttempts + ')...')
      setTimeout(() => this.connectWebSocket(), 3000)
    }
  }

  updateConnectionStatus(connected) {
    const indicator = document.getElementById('wsStatus')
    const text = document.getElementById('wsStatusText')

    if (connected) {
      indicator.className = 'status-indicator connected'
      text.textContent = 'WebSocket å·²è¿æ¥'
    } else {
      indicator.className = 'status-indicator disconnected'
      text.textContent = 'WebSocket å·²æ–­å¼€'
    }
  }

  handleWebSocketMessage(message) {
    switch (message.type) {
      case 'progress':
        this.handleProgress(message.payload)
        break
      case 'result':
        this.handleResult(message.payload)
        break
      case 'complete':
        this.handleComplete(message.payload)
        break
      case 'status':
        console.log('æœåŠ¡å™¨çŠ¶æ€:', message.payload)
        break
      default:
        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type)
    }
  }

  handleProgress(progress) {
    const liveProgress = document.getElementById('liveProgress')
    const progressText = document.getElementById('progressText')

    liveProgress.style.display = 'block'
    progressText.textContent = progress.suite + ' - ' + progress.task + ' (' + progress.current + '/' + progress.total + ') ' + progress.percentage.toFixed(1) + '%'
  }

  handleResult(data) {
    console.log('æ”¶åˆ°ç»“æœ:', data)
    // å¯ä»¥åœ¨è¿™é‡Œå®æ—¶æ›´æ–° UI
  }

  handleComplete(data) {
    console.log('å¥—ä»¶å®Œæˆ:', data)
    const liveProgress = document.getElementById('liveProgress')
    liveProgress.style.display = 'none'

    // é‡æ–°åŠ è½½å†å²è®°å½•
    this.loadHistory()
  }

  async loadHistory() {
    try {
      const response = await fetch('/api/history')
      const history = await response.json()
      this.renderHistory(history)
    } catch (error) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error)
      document.getElementById('historyList').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>'
    }
  }

  renderHistory(history) {
    const historyList = document.getElementById('historyList')

    if (history.length === 0) {
      historyList.innerHTML = '<div class="loading">æš‚æ— å†å²è®°å½•</div>'
      return
    }

    historyList.innerHTML = history.map(item =>
      '<div class="history-item" onclick="dashboard.selectReport(\\'' + item.id + '\\')">' +
      '<div style="font-weight: bold;">' + new Date(item.timestamp).toLocaleString('zh-CN') + '</div>' +
      '<div style="color: #666; font-size: 0.9em;">' + item.suites + ' ä¸ªå¥—ä»¶ â€¢ ' + item.totalTasks + ' ä¸ªä»»åŠ¡</div>' +
    '</div>'
    ).join('')
  }

  async selectReport(reportId) {
    // ç§»é™¤ä¹‹å‰çš„ active çŠ¶æ€
    document.querySelectorAll('.history-item').forEach(item => {
      item.classList.remove('active')
    })

    // æ·»åŠ  active çŠ¶æ€åˆ°å½“å‰é¡¹
    event.target.closest('.history-item').classList.add('active')

    try {
      const response = await fetch('/api/report/' + reportId)
      const report = await response.json()
      this.currentReport = report
      this.renderReport(report)
    } catch (error) {
      console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error)
    }
  }

  renderReport(report) {
    const reportView = document.getElementById('reportView')

    const stats = {
      totalSuites: report.suites.length,
      totalTasks: report.suites.reduce((sum, suite) => sum + suite.results.length, 0)
    }

    reportView.innerHTML =
      '<div>' +
      '<h2>' + report.name + '</h2>' +
      '<p style="color: #666; margin-bottom: 20px;">ç”Ÿæˆæ—¶é—´: ' + new Date(report.generatedAt).toLocaleString('zh-CN') + '</p>' +
      '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">' +
      '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + stats.totalSuites + '</div>' +
      '<div style="color: #666;">æµ‹è¯•å¥—ä»¶</div>' +
      '</div>' +
      '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center;">' +
      '<div style="font-size: 24px; font-weight: bold;">' + stats.totalTasks + '</div>' +
      '<div style="color: #666;">æµ‹è¯•ä»»åŠ¡</div>' +
      '</div>' +
      '</div>' +
      report.suites.map(suite =>
        '<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">' +
        '<h3>' + suite.name + '</h3>' +
        '<div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">' +
        '<div style="font-weight: bold;">ä»»åŠ¡åç§°</div>' +
        '<div style="font-weight: bold;">æ“ä½œ/ç§’</div>' +
        '<div style="font-weight: bold;">å¹³å‡æ—¶é—´</div>' +
        '<div style="font-weight: bold;">è¯¯å·®</div>' +
        suite.results.map(result =>
          '<div>' + result.name + '</div>' +
          '<div>' + this.formatOps(result.opsPerSecond) + '</div>' +
          '<div>' + result.avgTime.toFixed(4) + 'ms</div>' +
          '<div>Â±' + result.rme.toFixed(2) + '%</div>'
        ).join('') +
        '</div>' +
        '</div>'
      ).join('') +
      '</div>'
  }

  formatOps(ops) {
    if (ops >= 1000000) return (ops / 1000000).toFixed(1) + 'M'
    if (ops >= 1000) return (ops / 1000).toFixed(1) + 'K'
    return ops.toFixed(0)
  }
}

  /**
   * æä¾›å†å²è®°å½•åˆ—è¡¨
   */
  private async serveHistoryList(_req: any, res: any): Promise < void> {
  const historyDir = this.options.historyDir

    if(!existsSync(historyDir)) {
  res.writeHead(200, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify([]))
  return
}
}

const files = readdirSync(historyDir)
  .filter(f => f.endsWith('.json'))
  .sort()
  .reverse()
  .slice(0, 50) // é™åˆ¶è¿”å›æ•°é‡

const historyList = files.map(file => {
  const filePath = join(historyDir, file)
  const content = readFileSync(filePath, 'utf-8')
  const report = JSON.parse(content)

  return {
    id: file.replace('.json', ''),
    name: report.name,
    timestamp: report.generatedAt,
    suites: report.suites.length,
    totalTasks: report.suites.reduce((sum: number, s: any) => sum + s.results.length, 0)
  }
})

res.writeHead(200, { 'Content-Type': 'application/json' })
res.end(JSON.stringify(historyList))
  }

  /**
   * æä¾›å…·ä½“æŠ¥å‘Š
   */
  private async serveReport(_req: any, res: any, pathname: string): Promise < void> {
  const reportId = pathname.split('/').pop()?.replace('.json', '')

    if(!reportId) {
    res.writeHead(400, { 'Content-Type': 'application/json' })
    res.end(JSON.stringify({ error: 'Invalid report ID' }))
    return
  }

    const reportPath = join(this.options.historyDir, `${reportId}.json`)

    if(!existsSync(reportPath)) {
  res.writeHead(404, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({ error: 'Report not found' }))
  return
}

const content = readFileSync(reportPath, 'utf-8')
const report = JSON.parse(content)

res.writeHead(200, { 'Content-Type': 'application/json' })
res.end(JSON.stringify(report))
  }

  /**
   * æä¾›å¯¹æ¯”æ•°æ®
   */
  private async serveComparison(req: any, res: any): Promise < void> {
  const url = new URL(req.url || '/', `http://${req.headers.host}`)
    const reportIds = url.searchParams.get('reports')?.split(',') || []

    // æ”¯æŒæ—§çš„ baseline/current å‚æ•°
    const baselineId = url.searchParams.get('baseline')
    const currentId = url.searchParams.get('current')

    if(baselineId && currentId) {
  // æ—§çš„åŒæŠ¥å‘Šå¯¹æ¯”
  return this.serveTwoReportComparison(baselineId, currentId, res)
}

if (reportIds.length < 2) {
  res.writeHead(400, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({ error: 'At least 2 report IDs required. Use ?reports=id1,id2,id3' }))
  return
}

try {
  const comparison = await this.getComparisonData(reportIds)
  res.writeHead(200, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify(comparison))
} catch (error) {
  console.error('å¯¹æ¯”æŠ¥å‘Šå¤±è´¥:', error)
  res.writeHead(500, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({ error: 'Failed to compare reports' }))
}
  }

  /**
   * æ—§çš„åŒæŠ¥å‘Šå¯¹æ¯”ï¼ˆå‘åå…¼å®¹ï¼‰
   */
  private async serveTwoReportComparison(baselineId: string, currentId: string, res: any): Promise < void> {
  const baselinePath = join(this.options.historyDir, `${baselineId}.json`)
    const currentPath = join(this.options.historyDir, `${currentId}.json`)

    if(!existsSync(baselinePath) || !existsSync(currentPath)) {
  res.writeHead(404, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({ error: 'One or both reports not found' }))
  return
}

const baselineContent = readFileSync(baselinePath, 'utf-8')
const currentContent = readFileSync(currentPath, 'utf-8')

const baselineReport = JSON.parse(baselineContent)
const currentReport = JSON.parse(currentContent)

const comparison = this.compareReports(baselineReport, currentReport)

res.writeHead(200, { 'Content-Type': 'application/json' })
res.end(JSON.stringify(comparison))
  }

  /**
   * è·å–å¤šæŠ¥å‘Šå¯¹æ¯”æ•°æ®
   */
  async getComparisonData(reportIds: string[]): Promise < any > {
  const reports: any[] = []

    // åŠ è½½æ‰€æœ‰æŠ¥å‘Š
    for(const reportId of reportIds) {
    const reportPath = join(this.options.historyDir, `${reportId}.json`)
    if (!existsSync(reportPath)) {
      throw new Error(`Report not found: ${reportId}`)
    }

    const content = readFileSync(reportPath, 'utf-8')
    const report = JSON.parse(content)
    reports.push({
      id: reportId,
      name: report.name,
      generatedAt: report.generatedAt,
      report
    })
  }

    // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„å¥—ä»¶å’Œä»»åŠ¡
    const taskMap = new Map<string, Map<string, any[]>>()

    for(const { id, report } of reports) {
    for (const suite of report.suites || []) {
      if (!taskMap.has(suite.name)) {
        taskMap.set(suite.name, new Map())
      }

      const suiteMap = taskMap.get(suite.name)!

      for (const result of suite.results || []) {
        if (!suiteMap.has(result.name)) {
          suiteMap.set(result.name, [])
        }

        suiteMap.get(result.name)!.push({
          reportId: id,
          opsPerSecond: result.opsPerSecond,
          avgTime: result.avgTime,
          minTime: result.minTime,
          maxTime: result.maxTime,
          rme: result.rme
        })
      }
    }
  }

    // æ„å»ºå¯¹æ¯”æ•°æ®
    const comparisons: any[] = []

    for(const [suiteName, suiteMap] of taskMap.entries()) {
  for (const [taskName, values] of suiteMap.entries()) {
    if (values.length < 2) continue // è‡³å°‘éœ€è¦2ä¸ªæŠ¥å‘Šæ‰èƒ½å¯¹æ¯”

    // è®¡ç®—è¶‹åŠ¿
    const firstOps = values[0].opsPerSecond
    const lastOps = values[values.length - 1].opsPerSecond
    const improvement = ((lastOps - firstOps) / firstOps) * 100

    comparisons.push({
      suite: suiteName,
      task: taskName,
      values,
      trend: improvement > 5 ? 'improving' : improvement < -5 ? 'degrading' : 'stable',
      improvement,
      avgOpsPerSecond: values.reduce((sum, v) => sum + v.opsPerSecond, 0) / values.length,
      avgTime: values.reduce((sum, v) => sum + v.avgTime, 0) / values.length
    })
  }
}

// è®¡ç®—æ±‡æ€»ç»Ÿè®¡
const improvements = comparisons.filter(c => c.trend === 'improving').length
const regressions = comparisons.filter(c => c.trend === 'degrading').length
const stable = comparisons.filter(c => c.trend === 'stable').length
const avgChange = comparisons.reduce((sum, c) => sum + c.improvement, 0) / comparisons.length || 0

return {
  reports: reports.map(r => ({
    id: r.id,
    name: r.name,
    generatedAt: r.generatedAt
  })),
  comparisons,
  summary: {
    totalComparisons: comparisons.length,
    improvements,
    regressions,
    stable,
    avgChange
  }
}
  }

  /**
   * æä¾›æœåŠ¡å™¨çŠ¶æ€
   */
  private async serveStatus(_req: any, res: any): Promise < void> {
  const status = {
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    timestamp: new Date().toISOString(),
    historyCount: this.getHistoryCount()
  }

    res.writeHead(200, { 'Content-Type': 'application/json' })
    res.end(JSON.stringify(status))
}

  /**
   * å¯¹æ¯”ä¸¤ä¸ªæŠ¥å‘Š
   */
  private compareReports(baseline: any, current: any): any {
  const comparisons: any[] = []

  for (const currentSuite of current.suites) {
    const baselineSuite = baseline.suites.find((s: any) => s.name === currentSuite.name)
    if (!baselineSuite) continue

    for (const currentResult of currentSuite.results) {
      const baselineResult = baselineSuite.results.find((r: any) => r.name === currentResult.name)
      if (!baselineResult) continue

      const improvement = ((currentResult.opsPerSecond - baselineResult.opsPerSecond) / baselineResult.opsPerSecond) * 100
      comparisons.push({
        suite: currentSuite.name,
        task: currentResult.name,
        baselineOps: baselineResult.opsPerSecond,
        currentOps: currentResult.opsPerSecond,
        improvement,
        isRegression: improvement < -5, // æ€§èƒ½ä¸‹é™è¶…è¿‡ 5%
        isImprovement: improvement > 5   // æ€§èƒ½æå‡è¶…è¿‡ 5%
      })
    }
  }

  return {
    baseline: baseline.generatedAt,
    current: current.generatedAt,
    comparisons,
    summary: {
      totalComparisons: comparisons.length,
      improvements: comparisons.filter(c => c.isImprovement).length,
      regressions: comparisons.filter(c => c.isRegression).length,
      avgImprovement: comparisons.reduce((sum, c) => sum + c.improvement, 0) / comparisons.length
    }
  }
}

  /**
   * è·å–å†å²è®°å½•æ•°é‡
   */
  private getHistoryCount(): number {
  const historyDir = this.options.historyDir
  if (!existsSync(historyDir)) return 0

  const files = readdirSync(historyDir)
  return files.filter(f => f.endsWith('.json')).length
}

  /**
   * æä¾›è¶‹åŠ¿æ•°æ® API
   */
  private async serveTrendData(req: any, res: any, pathname: string): Promise < void> {
  // è§£æè·¯å¾„: /api/trend/{suiteName}/{taskName}
  const parts = pathname.split('/').filter(Boolean)
    if(parts.length < 4) {
  res.writeHead(400, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({ error: 'Invalid trend API path. Expected: /api/trend/{suiteName}/{taskName}' }))
  return
}

const suiteName = decodeURIComponent(parts[2])
const taskName = decodeURIComponent(parts[3])

const url = new URL(req.url || '/', `http://${req.headers.host}`)
const range = url.searchParams.get('range') || 'month' // week, month, quarter, year
const points = parseInt(url.searchParams.get('points') || '30')

try {
  const trendData = await this.getTrendData(suiteName, taskName, { range, points })
  res.writeHead(200, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify(trendData))
} catch (error) {
  console.error('è·å–è¶‹åŠ¿æ•°æ®å¤±è´¥:', error)
  res.writeHead(500, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({ error: 'Failed to get trend data' }))
}
  }

  /**
   * è·å–è¶‹åŠ¿æ•°æ®
   */
  async getTrendData(
  suiteName: string,
  taskName: string,
  options ?: { range?: string; points?: number }
): Promise < any > {
  const historyDir = this.options.historyDir

    if(!existsSync(historyDir)) {
  return {
    task: taskName,
    suite: suiteName,
    dataPoints: [],
    trend: 'stable',
    changeRate: 0
  }
}

// è®¡ç®—æ—¶é—´èŒƒå›´
const now = new Date()
const rangeMap: Record<string, number> = {
  week: 7 * 24 * 60 * 60 * 1000,
  month: 30 * 24 * 60 * 60 * 1000,
  quarter: 90 * 24 * 60 * 60 * 1000,
  year: 365 * 24 * 60 * 60 * 1000
}
const rangeMs = rangeMap[options?.range || 'month'] || rangeMap.month
const startDate = new Date(now.getTime() - rangeMs)

// è¯»å–æ‰€æœ‰å†å²æ–‡ä»¶
const files = readdirSync(historyDir)
  .filter(f => f.endsWith('.json'))
  .sort()
  .reverse()

const dataPoints: any[] = []

for (const file of files) {
  try {
    const filePath = path.join(historyDir, file)
    const content = readFileSync(filePath, 'utf-8')
    const report = JSON.parse(content)

    const reportDate = new Date(report.generatedAt)
    if (reportDate < startDate) continue

    // æŸ¥æ‰¾åŒ¹é…çš„å¥—ä»¶å’Œä»»åŠ¡
    const suite = report.suites?.find((s: any) => s.name === suiteName)
    if (!suite) continue

    const result = suite.results?.find((r: any) => r.name === taskName)
    if (!result) continue

    dataPoints.push({
      timestamp: reportDate.getTime(),
      date: report.generatedAt,
      opsPerSecond: result.opsPerSecond,
      avgTime: result.avgTime,
      minTime: result.minTime,
      maxTime: result.maxTime,
      rme: result.rme,
      commitHash: report.environment?.gitCommit,
      branch: report.environment?.gitBranch
    })

    // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
    if (dataPoints.length >= (options?.points || 30)) {
      break
    }
  } catch (error) {
    console.error(`è§£ææ–‡ä»¶ ${file} å¤±è´¥:`, error)
  }
}

// åè½¬æ•°æ®ç‚¹ï¼Œä½¿å…¶æŒ‰æ—¶é—´æ­£åºæ’åˆ—
dataPoints.reverse()

// è®¡ç®—è¶‹åŠ¿
const trend = this.calculateTrend(dataPoints)
const changeRate = this.calculateChangeRate(dataPoints)

return {
  task: taskName,
  suite: suiteName,
  dataPoints,
  trend,
  changeRate,
  summary: {
    totalPoints: dataPoints.length,
    avgOpsPerSecond: dataPoints.reduce((sum, p) => sum + p.opsPerSecond, 0) / dataPoints.length || 0,
    avgTime: dataPoints.reduce((sum, p) => sum + p.avgTime, 0) / dataPoints.length || 0,
    range: options?.range || 'month'
  }
}
  }

  /**
   * è®¡ç®—è¶‹åŠ¿æ–¹å‘
   */
  private calculateTrend(dataPoints: any[]): 'improving' | 'stable' | 'degrading' {
  if (dataPoints.length < 2) return 'stable'

  const firstHalf = dataPoints.slice(0, Math.floor(dataPoints.length / 2))
  const secondHalf = dataPoints.slice(Math.floor(dataPoints.length / 2))

  const firstAvg = firstHalf.reduce((sum, p) => sum + p.opsPerSecond, 0) / firstHalf.length
  const secondAvg = secondHalf.reduce((sum, p) => sum + p.opsPerSecond, 0) / secondHalf.length

  const change = ((secondAvg - firstAvg) / firstAvg) * 100

  if (change > 5) return 'improving'
  if (change < -5) return 'degrading'
  return 'stable'
}

  /**
   * è®¡ç®—å˜åŒ–ç‡ï¼ˆç™¾åˆ†æ¯”/å‘¨ï¼‰
   */
  private calculateChangeRate(dataPoints: any[]): number {
  if (dataPoints.length < 2) return 0

  const first = dataPoints[0]
  const last = dataPoints[dataPoints.length - 1]

  const timeDiff = last.timestamp - first.timestamp
  const weeks = timeDiff / (7 * 24 * 60 * 60 * 1000)

  if (weeks === 0) return 0

  const opsChange = ((last.opsPerSecond - first.opsPerSecond) / first.opsPerSecond) * 100

  return opsChange / weeks
}
}

// CLI å¯åŠ¨å…¥å£
if (import.meta.url === `file://${process.argv[1]}`) {
  const options = {
    port: parseInt(process.env.PORT || '3000'),
    host: process.env.HOST || 'localhost'
  }

  const server = new BenchmarkServer(options)

  server.start().catch(console.error)

  // ä¼˜é›…å…³é—­
  process.on('SIGINT', async () => {
    console.log('\nğŸ‘‹ æ­£åœ¨å…³é—­æœåŠ¡å™¨...')
    await server.stop()
    process.exit(0)
  })

  process.on('SIGTERM', async () => {
    await server.stop()
    process.exit(0)
  })
}

export default BenchmarkServer
